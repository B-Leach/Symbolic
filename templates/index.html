<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Symbolic Learning - Genetic Programming Demo</title>
  <link href="{{ url_for('static', filename='/css/styles.css') }}" type="text/css" rel="stylesheet">
</head>
<body>

  <!-- Loading Overlay -->
  <div id="hider">
    <div id="loader"></div>
    <div id="loader-text">Training model...</div>
  </div>

  <div class="container">

    <!-- Header -->
    <header class="header">
      <h1>Symbolic Learning</h1>
      <p>Discover mathematical formulas through genetic programming</p>
    </header>

    <!-- Main Content Grid -->
    <div class="main-grid">

      <!-- Left Column: Controls & Results -->
      <div class="left-column">

        <!-- Equation Builder Card -->
        <div class="card">
          <h2 class="card-title">Equation to Learn</h2>

          <div class="equation-builder">
            <div class="equation-display">
              <span class="symbol">y =</span>
              <input type="number" name="e1" id="e1" value="{{e1}}" step="0.1">
              <span class="func">cos(</span>
              <input type="number" name="c1" id="c1" value="{{c1}}" step="0.1">
              <span class="symbol">x )</span>
              <span class="symbol">+</span>
              <input type="number" name="e2" id="e2" value="{{e2}}" step="0.1">
              <span class="func">sin(</span>
              <input type="number" name="c2" id="c2" value="{{c2}}" step="0.1">
              <span class="symbol">x )</span>
              <span class="symbol">·</span>
              <input type="number" name="e3" id="e3" value="{{e3}}" step="0.1">
              <span class="func">arctan(</span>
              <input type="number" name="c3" id="c3" value="{{c3}}" step="0.1">
              <span class="symbol">x )</span>
            </div>

            <div class="checkbox-wrapper" onclick="document.getElementById('low_memory').click()">
              <input type="checkbox" id="low_memory">
              <label for="low_memory">Low Memory Mode (faster, less detail)</label>
            </div>

            <div class="btn-group">
              <button class="btn btn-secondary" onclick="randomize()" id="btn-random">
                Randomize
              </button>
              <button class="btn btn-primary" onclick="startTraining()" id="btn-learn">
                Learn
              </button>
              <button class="btn btn-secondary" onclick="replayAnimation()" id="btn-replay">
                Replay
              </button>
            </div>
          </div>
        </div>

        <!-- Results Card -->
        <div class="card">
          <h2 class="card-title">Results</h2>

          <div class="results-grid">
            <div class="result-item success">
              <div class="result-label">R² Score</div>
              <div class="result-value" id="r2_score">{{r2_score}}</div>
            </div>
            <div class="result-item warning">
              <div class="result-label">Mean Absolute Error</div>
              <div class="result-value" id="mae_score">{{mae_score}}</div>
            </div>
          </div>

          <div class="result-item" style="margin-top: 15px;">
            <div class="result-label">Discovered Equation</div>
            <div class="result-value" id="formatted_eq" style="font-size: 1rem;">{{pr_eq_formatted}}</div>
          </div>

          <div class="stats-row">
            <span class="stat-badge">Population: <strong>{{ps}}</strong></span>
            <span class="stat-badge">Generations: <strong>{{ga}}</strong></span>
            <span class="stat-badge">Training: <strong>{{samples}}%</strong></span>
          </div>
        </div>

        <!-- About Section -->
        <details class="about-section">
          <summary>About Symbolic Learning</summary>
          <div class="content">
            <p>
              This demo uses <strong>symbolic regression</strong> via genetic programming to discover
              mathematical formulas that fit the target equation you define.
            </p>
            <p>
              The algorithm evolves a population of candidate equations over multiple generations.
              Each generation, the best-performing equations are selected and combined to create
              new candidates. Over time, the population converges toward formulas that accurately
              represent the target function.
            </p>
            <p>
              <strong>R² Score</strong> measures how well the prediction explains the variance in
              the data (1.0 = perfect fit). <strong>MAE</strong> shows the average absolute error
              between predicted and actual values.
            </p>
          </div>
        </details>

      </div>

      <!-- Right Column: Visualization -->
      <div class="right-column">
        <div class="card">
          <h2 class="card-title">Visualization</h2>
          <div class="video-container">
            <div id="full_plot"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Initialize video on page load
    document.addEventListener('DOMContentLoaded', function() {
      const plotHtml = `{{full_plot|safe}}`;
      if (plotHtml && plotHtml.trim()) {
        document.getElementById('full_plot').innerHTML = plotHtml;
        setupVideo();
      }

      document.getElementById('low_memory').checked = "{{low_mem}}" === "True";
    });

    function setupVideo() {
      const videos = document.getElementsByTagName('video');
      for (let vid of videos) {
        vid.controls = false;
        vid.setAttribute('playsinline', 'playsinline');
        vid.muted = true;
        vid.play().catch(() => {});
      }
    }

    function replayAnimation() {
      const videos = document.getElementsByTagName('video');
      for (let vid of videos) {
        vid.pause();
        vid.currentTime = 0;
        vid.play().catch(() => {});
      }
    }

    function randomize() {
      const inputs = ['c1', 'e1', 'c2', 'e2', 'c3', 'e3'];
      inputs.forEach(id => {
        let val = 0;
        while (val === 0) {
          const r = Math.random();
          if (r < 0.5) val = Math.round(Math.random() * 2 * 10) / 10;
          else if (r < 0.8) val = Math.round(Math.random() * 5 * 10) / 10;
          else val = Math.round(Math.random() * 10 * 10) / 10;
        }
        document.getElementById(id).value = val;
      });
    }

    function setLoading(isLoading) {
      const hider = document.getElementById('hider');
      const btnLearn = document.getElementById('btn-learn');
      const btnRandom = document.getElementById('btn-random');

      if (isLoading) {
        hider.classList.add('active');
        btnLearn.disabled = true;
        btnRandom.disabled = true;
        btnLearn.textContent = 'Training...';
      } else {
        hider.classList.remove('active');
        btnLearn.disabled = false;
        btnRandom.disabled = false;
        btnLearn.textContent = 'Learn';
      }
    }

    function startTraining() {
      const params = {
        c1: document.getElementById('c1').value,
        e1: document.getElementById('e1').value,
        c2: document.getElementById('c2').value,
        e2: document.getElementById('e2').value,
        c3: document.getElementById('c3').value,
        e3: document.getElementById('e3').value,
        low_memory: document.getElementById('low_memory').checked ? 1 : 0
      };

      setLoading(true);

      fetch('/train', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(params)
      })
      .then(response => response.json())
      .then(data => {
        setLoading(false);

        if (data.success) {
          document.getElementById('full_plot').innerHTML = data.video_html;
          document.getElementById('r2_score').textContent = data.r2_score;
          document.getElementById('mae_score').textContent = data.mae_score;
          document.getElementById('formatted_eq').textContent = data.pr_eq_formatted;
          setupVideo();
        } else {
          alert('Training failed: ' + (data.error || 'Unknown error'));
          console.error(data.traceback);
        }
      })
      .catch(error => {
        setLoading(false);
        alert('Request failed: ' + error.message);
      });
    }
  </script>

</body>
</html>
