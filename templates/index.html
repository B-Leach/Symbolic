<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Symbolic Learning - Genetic Programming Demo</title>
  <link href="{{ url_for('static', filename='/css/styles.css') }}" type="text/css" rel="stylesheet">
</head>
<body>

  <!-- Loading Overlay -->
  <div id="hider">
    <div id="loader"></div>
    <div id="loader-text">Training model...</div>
  </div>

  <div class="container">

    <!-- Header -->
    <header class="header">
      <h1>Symbolic Learning</h1>
      <p>Discover mathematical formulas through genetic programming</p>
    </header>

    <!-- Main Content Grid -->
    <div class="main-grid">

      <!-- Left Column: Controls & Results -->
      <div class="left-column">

        <!-- Equation Builder Card -->
        <div class="card">
          <h2 class="card-title">Equation to Learn</h2>

          <div class="equation-builder">
            <div class="equation-input-wrapper">
              <label for="equation" class="equation-label">
                <span class="symbol">y =</span>
              </label>
              <input type="text" name="equation" id="equation" value="{{equation}}"
                     placeholder="e.g., 2*sin(x) + cos(2*x)"
                     class="equation-input">
            </div>

            <div class="help-text">
              <strong>Supported functions:</strong> sin, cos, tan, arctan/atan, sqrt, log/ln, exp, abs<br>
              <strong>Operators:</strong> +, -, *, /, ** (or ^)<br>
              <strong>Constants:</strong> pi, e<br>
              <strong>Variable:</strong> x
            </div>

            <div class="btn-group">
              <button class="btn btn-secondary" onclick="randomize()" id="btn-random">
                Random Example
              </button>
              <button class="btn btn-primary" onclick="startTraining()" id="btn-learn">
                Learn
              </button>
              <button class="btn btn-secondary" onclick="replayAnimation()" id="btn-replay">
                Replay
              </button>
            </div>
          </div>
        </div>

        <!-- Results Card -->
        <div class="card">
          <h2 class="card-title">Results</h2>

          <div class="results-grid">
            <div class="result-item success">
              <div class="result-label">R² Score</div>
              <div class="result-value" id="r2_score">{{r2_score}}</div>
            </div>
            <div class="result-item warning">
              <div class="result-label">Mean Absolute Error</div>
              <div class="result-value" id="mae_score">{{mae_score}}</div>
            </div>
          </div>

          <div class="result-item" style="margin-top: 15px;">
            <div class="result-label">Discovered Equation</div>
            <div class="result-value" id="formatted_eq" style="font-size: 1rem;">{{pr_eq_formatted}}</div>
          </div>

          <div class="stats-row">
            <span class="stat-badge">Population: <strong>{{ps}}</strong></span>
            <span class="stat-badge">Generations: <strong>{{ga}}</strong></span>
            <span class="stat-badge">Training: <strong>{{samples}}%</strong></span>
          </div>
        </div>

        <!-- About Section -->
        <details class="about-section">
          <summary>About Symbolic Learning</summary>
          <div class="content">
            <p>
              This demo uses <strong>symbolic regression</strong> via genetic programming to discover
              mathematical formulas that fit the target equation you define.
            </p>
            <p>
              The algorithm evolves a population of candidate equations over multiple generations.
              Each generation, the best-performing equations are selected and combined to create
              new candidates. Over time, the population converges toward formulas that accurately
              represent the target function.
            </p>
            <p>
              <strong>R² Score</strong> measures how well the prediction explains the variance in
              the data (1.0 = perfect fit). <strong>MAE</strong> shows the average absolute error
              between predicted and actual values.
            </p>
          </div>
        </details>

      </div>

      <!-- Right Column: Visualization -->
      <div class="right-column">
        <div class="card">
          <h2 class="card-title">Visualization</h2>
          <div class="video-container">
            <div id="full_plot"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Initialize video on page load
    document.addEventListener('DOMContentLoaded', function() {
      const plotHtml = `{{full_plot|safe}}`;
      if (plotHtml && plotHtml.trim()) {
        document.getElementById('full_plot').innerHTML = plotHtml;
        setupVideo();
      }
    });

    function setupVideo() {
      const videos = document.getElementsByTagName('video');
      for (let vid of videos) {
        vid.controls = false;
        vid.setAttribute('playsinline', 'playsinline');
        vid.muted = true;
        vid.play().catch(() => {});
      }
    }

    function replayAnimation() {
      const videos = document.getElementsByTagName('video');
      for (let vid of videos) {
        vid.pause();
        vid.currentTime = 0;
        vid.play().catch(() => {});
      }
    }

    function randomize() {
      const examples = [
        '2*sin(x) + cos(2*x)',
        'sin(x) * cos(x)',
        'x**2 + 3*x - 5',
        'exp(-x**2/10)',
        'sqrt(abs(x)) * sin(x)',
        'log(abs(x) + 1) * cos(x)',
        'arctan(x) + sin(2*x)',
        '3*sin(x) - 2*cos(3*x)',
        'x * exp(-x**2/20)',
        'sin(x) / (x + 0.1)',
        'cos(x) + sin(x**2/5)',
        'tan(x/3) + cos(x)'
      ];
      const randomExample = examples[Math.floor(Math.random() * examples.length)];
      document.getElementById('equation').value = randomExample;
    }

    function setLoading(isLoading) {
      const hider = document.getElementById('hider');
      const btnLearn = document.getElementById('btn-learn');
      const btnRandom = document.getElementById('btn-random');

      if (isLoading) {
        hider.classList.add('active');
        btnLearn.disabled = true;
        btnRandom.disabled = true;
        btnLearn.textContent = 'Training...';
      } else {
        hider.classList.remove('active');
        btnLearn.disabled = false;
        btnRandom.disabled = false;
        btnLearn.textContent = 'Learn';
      }
    }

    function startTraining() {
      const equation = document.getElementById('equation').value.trim();

      if (!equation) {
        alert('Please enter an equation');
        return;
      }

      const params = {
        equation: equation
      };

      setLoading(true);

      // First validate the equation
      fetch('/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(params)
      })
      .then(response => response.json())
      .then(validationData => {
        if (!validationData.valid) {
          setLoading(false);
          alert('Invalid equation: ' + (validationData.error || 'Unknown error'));
          return;
        }

        // If valid, proceed with training
        return fetch('/train', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
      })
      .then(response => {
        if (!response) return; // Validation failed
        return response.json();
      })
      .then(data => {
        if (!data) return; // Validation failed

        setLoading(false);

        if (data.success) {
          document.getElementById('full_plot').innerHTML = data.video_html;
          document.getElementById('r2_score').textContent = data.r2_score;
          document.getElementById('mae_score').textContent = data.mae_score;
          document.getElementById('formatted_eq').textContent = data.pr_eq_formatted;
          setupVideo();
        } else {
          alert('Training failed: ' + (data.error || 'Unknown error'));
          if (data.traceback) {
            console.error(data.traceback);
          }
        }
      })
      .catch(error => {
        setLoading(false);
        alert('Request failed: ' + error.message);
      });
    }
  </script>

</body>
</html>
